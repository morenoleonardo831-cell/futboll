<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modo Carreira Jogador ‚öΩ (Loja + Impostos + D√≠vidas)</title>

  <style>
    :root{
      --bg:#07130f;
      --text:#eafff6;
      --muted:#b8d8c9;
      --line:rgba(255,255,255,.10);
      --accent:#1ff29a;
      --accent2:#38a3ff;
      --danger:#ff5d5d;
      --gold:#ffd166;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(31,242,154,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(56,163,255,.14), transparent 55%),
        linear-gradient(180deg, #04100c, #07130f 50%, #040d09);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{ width:min(1180px, 100%); }

    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px; flex-wrap:wrap;
    }
    .logo{ display:flex; align-items:center; gap:12px; }
    .ball{
      width:44px; height:44px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #dff6ff 55%, #b9d5e7 100%);
      box-shadow: inset 0 0 0 3px rgba(0,0,0,.18), 0 16px 35px rgba(0,0,0,.35);
      position:relative; overflow:hidden;
    }
    .ball:before{
      content:""; position:absolute; inset:-20%;
      background: conic-gradient(from 0deg,
        rgba(0,0,0,.15), rgba(0,0,0,0) 12%,
        rgba(0,0,0,.12) 24%, rgba(0,0,0,0) 36%,
        rgba(0,0,0,.10) 48%, rgba(0,0,0,0) 60%,
        rgba(0,0,0,.12) 72%, rgba(0,0,0,0) 84%,
        rgba(0,0,0,.15));
      opacity:.9; mix-blend-mode:multiply;
    }
    h1{ font-size:22px; margin:0; letter-spacing:.4px; }
    .sub{ color:var(--muted); font-size:13px; margin-top:2px; }

    .topActions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(31,242,154,.10), rgba(0,0,0,0));
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .cardHeader h2{ margin:0; font-size:15px; letter-spacing:.3px; }
    .cardBody{ padding:14px; }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s opacity;
      font-weight:800; letter-spacing:.2px;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(0px); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    .btnPrimary{
      border-color: rgba(31,242,154,.35);
      background: linear-gradient(180deg, rgba(31,242,154,.22), rgba(31,242,154,.08));
    }
    .btnBlue{
      border-color: rgba(56,163,255,.35);
      background: linear-gradient(180deg, rgba(56,163,255,.20), rgba(56,163,255,.08));
    }
    .btnDanger{
      border-color: rgba(255,93,93,.35);
      background: linear-gradient(180deg, rgba(255,93,93,.18), rgba(255,93,93,.08));
    }
    .btnSmall{ padding:8px 10px; border-radius:12px; font-weight:850; font-size:13px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width:140px; }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      outline:none;
      background: rgba(0,0,0,.25);
      color: var(--text);
    }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .tag b{ color:var(--text); }

    .divider{ height:1px; background: var(--line); margin:12px 0; }

    .grid{
      display:grid;
      grid-template-columns: 400px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .pill{
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.18);
      margin-bottom:10px;
      gap:12px;
    }
    .pill .title{ font-weight:950; }
    .pill .desc{ font-size:12px; color:var(--muted); margin-top:2px; }
    .big{ font-size:34px; font-weight:950; letter-spacing:.6px; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.16);
    }
    .boxTitle{ font-weight:950; letter-spacing:.2px; }
    .boxSub{ color:var(--muted); font-size:12px; margin-top:2px; }
    .boxMid{
      margin-top:8px;
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:13px;
      line-height:1.35;
    }
    .boxMid b{ color:var(--text); }

    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }

    .screen{ display:none; animation: fade .20s ease-out; }
    .screen.active{ display:block; }
    @keyframes fade{ from{ opacity:.0; transform: translateY(4px); } to{ opacity:1; transform: translateY(0); } }

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      display:none; z-index:99;
      font-size:13px; color:var(--text);
      backdrop-filter: blur(10px);
      max-width: min(900px, calc(100% - 24px));
      text-align:center;
    }
    .toast.show{ display:block; animation: fade .18s ease-out; }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .tab{
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      transition:.15s transform, .15s background;
    }
    .tab:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .tab.active{
      border-color: rgba(31,242,154,.35);
      background: linear-gradient(180deg, rgba(31,242,154,.20), rgba(31,242,154,.08));
    }
    .panel{ display:none; }
    .panel.active{ display:block; }

    .statGrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
    }
    @media (max-width: 700px){ .statGrid{ grid-template-columns: repeat(2, 1fr); } }

    .meter{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background: rgba(0,0,0,.16);
    }
    .meter .k{ font-size:12px; color:var(--muted); }
    .meter .v{ font-weight:950; }

    .shopGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 780px){ .shopGrid{ grid-template-columns: 1fr; } }

    .tiny{ font-size:11px; color:var(--muted); line-height:1.35; }

    /* Modais */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      z-index:120;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width:min(820px, 100%);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.25));
    }
    .modalHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,93,93,.10), rgba(0,0,0,0));
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .modalHead .t{ font-weight:950; letter-spacing:.2px; }
    .modalBody{ padding:14px; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="brand">
      <div class="logo">
        <div class="ball" aria-hidden="true"></div>
        <div>
          <h1>Modo Carreira Jogador</h1>
          <div class="sub">Loja (financiamento), IPTU, imposto por temporada, sonega√ß√£o, d√≠vidas com juros.</div>
        </div>
      </div>

      <div class="topActions">
        <button class="btn btnSmall" id="btnLoad">Carregar</button>
        <button class="btn btnSmall" id="btnSave">Salvar</button>
        <button class="btn btnSmall btnDanger" id="btnExit">Sair do jogo</button>
      </div>
    </div>

    <!-- START -->
    <div class="screen active" id="screenStart">
      <div class="card">
        <div class="cardHeader">
          <h2>Iniciar</h2>
          <span class="tag">‚öΩ <b>Carreira</b> ‚Ä¢ üõí Loja ‚Ä¢ üßæ Impostos</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col">
              <label>Nome do jogador</label>
              <input id="inpName" placeholder="Ex: Leonardo Moreno" maxlength="22" />
            </div>
            <div class="col">
              <label>Nacionalidade</label>
              <select id="selNat">
                <option value="Brasil">Brasil</option>
                <option value="Inglaterra">Inglaterra</option>
                <option value="Argentina">Argentina</option>
                <option value="Portugal">Portugal</option>
                <option value="Espanha">Espanha</option>
                <option value="Fran√ßa">Fran√ßa</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label>Posi√ß√£o</label>
              <select id="selPos">
                <option value="AUTO">Aleat√≥ria</option>
                <option value="ATA">ATA</option>
                <option value="PE">PE</option>
                <option value="PD">PD</option>
                <option value="MEI">MEI</option>
                <option value="VOL">VOL</option>
                <option value="ZAG">ZAG</option>
                <option value="LAT">LAT</option>
                <option value="GOL">GOL</option>
              </select>
            </div>

            <div class="col">
              <label>Dificuldade</label>
              <select id="selDiff">
                <option value="FACIL">F√°cil</option>
                <option value="MEDIO" selected>M√©dio</option>
                <option value="DIFICIL">Dif√≠cil</option>
              </select>
            </div>

            <div class="col">
              <label>Liga inicial</label>
              <select id="selStartLeague">
                <option value="AUTO" selected>Autom√°tico</option>
                <option value="BR">Brasil</option>
                <option value="EN">Inglaterra</option>
                <option value="AR">Argentina</option>
                <option value="ES">Espanha</option>
              </select>
            </div>

            <div class="col">
              <label>Come√ßar onde?</label>
              <select id="selStartType">
                <option value="AUTO" selected>Autom√°tico</option>
                <option value="Base">Base</option>
                <option value="Profissional">Profissional</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn btnPrimary" id="btnGenerate">üé≤ Gerar Jogador</button>
            <button class="btn btnBlue" id="btnStartCareer">üöÄ Come√ßar Carreira</button>
          </div>

          <div class="divider"></div>

          <div class="hint">
            ‚Ä¢ <b>Imposto por temporada</b>: voc√™ escolhe pagar ou sonegar.<br>
            ‚Ä¢ Se sonegar e cair: <b>multa 150%</b> do total e vira d√≠vida.<br>
            ‚Ä¢ <b>D√≠vida acumula juros toda semana</b>.<br>
            ‚Ä¢ Loja tem <b>financiamento</b>, <b>manuten√ß√£o semanal</b>, e <b>IPTU por temporada</b> em im√≥veis.
          </div>
        </div>
      </div>
    </div>

    <!-- PICK CLUB -->
    <div class="screen" id="screenClubPick">
      <div class="card">
        <div class="cardHeader">
          <h2>Escolha seu clube inicial</h2>
          <span class="tag">üèüÔ∏è 3 op√ß√µes</span>
        </div>
        <div class="cardBody">
          <div class="hint" id="pickHint" style="margin-bottom:10px"></div>
          <div class="shopGrid" id="clubPickList"></div>
          <div class="divider"></div>
          <div class="row">
            <button class="btn" id="btnBackToStart">‚¨ÖÔ∏è Voltar</button>
            <button class="btn btnPrimary" id="btnConfirmPick" disabled>‚úÖ Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div class="screen" id="screenGame">
      <div class="grid">

        <div class="card">
          <div class="cardHeader">
            <h2>Seu Jogador</h2>
            <span class="tag">üí∞ Carteira ‚Ä¢ üìå D√≠vidas ‚Ä¢ üòÑ Felicidade</span>
          </div>
          <div class="cardBody" id="playerPanel"></div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Central</h2>
            <span class="tag" id="midTag">ü™ü Janela</span>
          </div>
          <div class="cardBody">
            <div class="tabs">
              <button class="tab active" data-tab="tabTemporada">Temporada</button>
              <button class="tab" data-tab="tabPropostas">Propostas</button>
              <button class="tab" data-tab="tabFinancas">Finan√ßas</button>
              <button class="tab" data-tab="tabLoja">Loja</button>
              <button class="tab" data-tab="tabHistorico">Hist√≥rico</button>
            </div>

            <!-- TEMPORADA -->
            <div class="panel active" id="tabTemporada">
              <div class="pill">
                <div>
                  <div class="title">Progresso</div>
                  <div class="desc" id="seasonLine">Temporada 1 ‚Ä¢ Semana 1/38</div>
                </div>
                <div class="big" id="weekBig">1</div>
              </div>

              <div class="row">
                <button class="btn btnPrimary" id="btnPlayWeek">‚ñ∂Ô∏è Jogar Semana</button>
                <button class="btn" id="btnTrain">üèãÔ∏è Treinar</button>
                <button class="btn" id="btnRest">üõå Descansar</button>
                <button class="btn btnBlue" id="btnEndSeason">üèÅ Finalizar Temporada</button>
              </div>

              <div class="divider"></div>

              <div class="pill">
                <div>
                  <div class="title">Impostos & D√≠vidas</div>
                  <div class="desc" id="taxLine">No fim da temporada voc√™ decide pagar ou sonegar.</div>
                </div>
                <span class="tag" id="taxTag">üßæ OK</span>
              </div>

              <div class="box" id="taxBox"></div>

              <div class="divider"></div>

              <div class="pill">
                <div>
                  <div class="title">Notifica√ß√µes</div>
                  <div class="desc">As antigas somem pra n√£o lotar</div>
                </div>
                <span class="tag" id="newsTag">üì∞ 0</span>
              </div>

              <div class="list" id="newsList"></div>
            </div>

            <!-- PROPOSTAS -->
            <div class="panel" id="tabPropostas">
              <div class="pill">
                <div>
                  <div class="title">Negocia√ß√µes</div>
                  <div class="desc">Meio (semana 19) e fim da temporada</div>
                </div>
                <div class="row">
                  <button class="btn btnSmall" id="btnRenew">üîÅ Renovar</button>
                  <button class="btn btnSmall" id="btnClearOffers">Limpar</button>
                </div>
              </div>
              <div class="list" id="offersList"></div>
            </div>

            <!-- FINAN√áAS -->
            <div class="panel" id="tabFinancas">
              <div class="pill">
                <div>
                  <div class="title">Banco + D√≠vidas</div>
                  <div class="desc">Banco rende 1%/sem ‚Ä¢ D√≠vida (imposto+geral) rende 1,5%/sem</div>
                </div>
                <span class="tag">üí≥ <b>Santander</b></span>
              </div>

              <div class="statGrid" id="bankMeters"></div>

              <div class="divider"></div>

              <div class="row">
                <div class="col">
                  <label>Valor para investir</label>
                  <input id="inpInvest" type="number" min="0" step="1000" placeholder="Ex: 50000" />
                </div>
                <button class="btn btnPrimary" id="btnInvest">Investir</button>
              </div>

              <div class="row" style="margin-top:10px">
                <div class="col">
                  <label>Valor para resgatar</label>
                  <input id="inpWithdraw" type="number" min="0" step="1000" placeholder="Ex: 20000" />
                </div>
                <button class="btn btnBlue" id="btnWithdraw">Resgatar</button>
              </div>

              <div class="divider"></div>

              <div class="row">
                <div class="col">
                  <label>Pagar d√≠vida (qualquer valor)</label>
                  <input id="inpPayDebt" type="number" min="0" step="1000" placeholder="Ex: 10000" />
                </div>
                <button class="btn" id="btnPayDebt">Pagar D√≠vida</button>
              </div>

              <div class="divider"></div>

              <div class="pill">
                <div>
                  <div class="title">Financiamentos ativos</div>
                  <div class="desc">Parcelas s√£o cobradas automaticamente ao jogar semana</div>
                </div>
                <span class="tag" id="loanTag">üìÑ 0</span>
              </div>

              <div class="list" id="loanList"></div>
              <div class="tiny">Se faltar dinheiro na parcela/manuten√ß√£o, vira d√≠vida e sua reputa√ß√£o pode cair.</div>
            </div>

            <!-- LOJA -->
            <div class="panel" id="tabLoja">
              <div class="pill">
                <div>
                  <div class="title">Loja & Patrim√¥nio</div>
                  <div class="desc">Comprar, financiar, vender ‚Ä¢ Itens valorizam/desvalorizam ‚Ä¢ IPTU em im√≥veis</div>
                </div>
                <span class="tag" id="netWorthTag">üè† Patrim√¥nio: <b>R$ 0</b></span>
              </div>

              <div class="shopGrid" id="shopList"></div>

              <div class="divider"></div>

              <div class="pill">
                <div>
                  <div class="title">Seus itens</div>
                  <div class="desc">Valor atual + manuten√ß√£o + venda</div>
                </div>
                <span class="tag" id="ownedTag">üì¶ 0</span>
              </div>

              <div class="list" id="ownedList"></div>
              <div class="tiny">Venda tem taxa de 5% (corretagem). Im√≥veis pagam IPTU no fim da temporada.</div>
            </div>

            <!-- HIST√ìRICO -->
            <div class="panel" id="tabHistorico">
              <div class="pill">
                <div>
                  <div class="title">Hist√≥rico</div>
                  <div class="desc">√öltimas 20 temporadas</div>
                </div>
                <span class="tag" id="histTag">üìö 0 temporadas</span>
              </div>
              <div class="list" id="historyList"></div>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- MODAL IMPOSTO (TOTAL: renda + IPTU) -->
  <div class="modalBack" id="taxModalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="t">üßæ Impostos da Temporada</div>
        <span class="tag" id="taxModalRisk">üëÄ Risco: 0%</span>
      </div>
      <div class="modalBody" id="taxModalBody"></div>
    </div>
  </div>

  <!-- MODAL FINANCIAMENTO -->
  <div class="modalBack" id="finModalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="t">üìÑ Financiamento</div>
        <span class="tag" id="finModalTag">üí∞</span>
      </div>
      <div class="modalBody" id="finModalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  // =========================
  // LIGAS
  // =========================
  const BRASILEIRAO = [
    "Atl√©tico Mineiro","Bahia","Botafogo","Cear√°","Corinthians","Cruzeiro","Flamengo","Fluminense","Fortaleza","Gr√™mio",
    "Internacional","Juventude","Mirassol","Palmeiras","Red Bull Bragantino","Santos","S√£o Paulo","Sport","Vasco da Gama","Vit√≥ria"
  ];
  const PREMIER = [
    "Arsenal","Aston Villa","Bournemouth","Brentford","Brighton & Hove Albion","Burnley","Chelsea","Crystal Palace","Everton","Fulham",
    "Leeds United","Liverpool","Manchester City","Manchester United","Newcastle United","Nottingham Forest","Sunderland","Tottenham Hotspur","West Ham United","Wolverhampton Wanderers"
  ];
  const ARGENTINA = [
    "Boca Juniors","River Plate","Racing Club","Independiente","San Lorenzo",
    "Estudiantes","V√©lez Sarsfield","Lan√∫s","Rosario Central","Newell's Old Boys",
    "Defensa y Justicia","Talleres","Hurac√°n","Argentinos Juniors","Godoy Cruz",
    "Banfield","Belgrano","Uni√≥n","Platense","Sarmiento"
  ];
  const LALIGA = [
    "Real Madrid","Barcelona","Atl√©tico de Madrid","Sevilla","Valencia",
    "Villarreal","Real Sociedad","Athletic Bilbao","Real Betis","Celta de Vigo",
    "Girona","Getafe","Mallorca","Osasuna","Rayo Vallecano",
    "Alav√©s","Granada","Las Palmas","C√°diz","Espanyol"
  ];

  const LEAGUES = [
    { id:"BR", name:"Brasileir√£o", currency:"R$", teams: BRASILEIRAO, repWeight: 1.00 },
    { id:"EN", name:"Premier League", currency:"¬£", teams: PREMIER, repWeight: 1.20 },
    { id:"AR", name:"Liga Argentina", currency:"$", teams: ARGENTINA, repWeight: 0.95 },
    { id:"ES", name:"La Liga", currency:"‚Ç¨", teams: LALIGA, repWeight: 1.15 }
  ];

  const POSITIONS = [
    { id:"ATA", label:"Centroavante", weights:{PAC:0.22, SHO:0.38, PAS:0.18, DEF:0.06, PHY:0.16} },
    { id:"PE",  label:"Ponta Esquerda", weights:{PAC:0.30, SHO:0.26, PAS:0.22, DEF:0.07, PHY:0.15} },
    { id:"PD",  label:"Ponta Direita", weights:{PAC:0.30, SHO:0.26, PAS:0.22, DEF:0.07, PHY:0.15} },
    { id:"MEI", label:"Armador", weights:{PAC:0.18, SHO:0.20, PAS:0.36, DEF:0.10, PHY:0.16} },
    { id:"VOL", label:"Volante", weights:{PAC:0.16, SHO:0.12, PAS:0.22, DEF:0.28, PHY:0.22} },
    { id:"ZAG", label:"Zagueiro", weights:{PAC:0.12, SHO:0.06, PAS:0.16, DEF:0.42, PHY:0.24} },
    { id:"LAT", label:"Lateral", weights:{PAC:0.26, SHO:0.10, PAS:0.24, DEF:0.24, PHY:0.16} },
    { id:"GOL", label:"Goleiro", weights:{PAC:0.05, SHO:0.03, PAS:0.07, DEF:0.70, PHY:0.15} }
  ];

  const DIFF = {
    FACIL:   { playMul: 1.10, growthMul: 1.15, injuryMul: 0.70 },
    MEDIO:   { playMul: 1.00, growthMul: 1.00, injuryMul: 1.00 },
    DIFICIL: { playMul: 0.90, growthMul: 0.85, injuryMul: 1.35 }
  };

  // =========================
  // LOJA (itens realistas)
  // =========================
  // appreciationSeason: +0.05 = valoriza 5% por temporada
  // depreciationSeason: -0.12 = desvaloriza 12% por temporada
  // maintenanceWeekly: custo semanal
  // iptuRateSeason: imposto por temporada sobre valor atual (im√≥vel/terreno)
  // moodGain / repGain: impacto ao comprar (e ao vender perde parte)
  const SHOP_ITEMS = [
    // Carros
    { id:"car_pop", type:"Carro", name:"Corolla", price: 130000,  depreciationSeason:-0.10, maintenanceWeekly: 350,  iptuRateSeason:0,   moodGain:3, repGain:0 },
    { id:"car_sport", type:"Carro", name:"BMW M", price: 350000,    depreciationSeason:-0.14, maintenanceWeekly: 800,  iptuRateSeason:0,   moodGain:6, repGain:1 },
    { id:"car_lux", type:"Carro", name:"Bentley", price: 1780000,   depreciationSeason:-0.16, maintenanceWeekly: 2200, iptuRateSeason:0,   moodGain:10, repGain:3 },

    // Casas/Im√≥veis
    { id:"ap_sp", type:"Im√≥vel", name:"Apartamento (S√£o Paulo)", price: 1220000, appreciationSeason:0.05, maintenanceWeekly: 600, iptuRateSeason:0.012, moodGain:7, repGain:1 },
    { id:"casa_en", type:"Im√≥vel", name:"Casa M√©dia (Manchester)", price: 3650000, appreciationSeason:0.04, maintenanceWeekly: 1100, iptuRateSeason:0.010, moodGain:9, repGain:2 },
    { id:"mansao", type:"Im√≥vel", name:"Mans√£o (Ibiza)", price: 16500000, appreciationSeason:0.06, maintenanceWeekly: 4500, iptuRateSeason:0.014, moodGain:14, repGain:4 },

    // Terrenos
    { id:"lote", type:"Terreno", name:"Terreno (1 lote)", price: 120000, appreciationSeason:0.03, maintenanceWeekly: 50, iptuRateSeason:0.006, moodGain:1, repGain:0 },
    { id:"fazenda", type:"Terreno", name:"Fazenda", price: 50000000, appreciationSeason:0.07, maintenanceWeekly: 8000, iptuRateSeason:0.008, moodGain:10, repGain:3 },

    // Luxo
    { id:"iate", type:"Luxo", name:"Iate", price: 12000000, depreciationSeason:-0.10, maintenanceWeekly: 9000, iptuRateSeason:0, moodGain:12, repGain:4 },
    { id:"jato", type:"Luxo", name:"Jato Particular", price: 75000000, depreciationSeason:-0.12, maintenanceWeekly: 22000, iptuRateSeason:0, moodGain:16, repGain:6 },
    { id:"heli", type:"Luxo", name:"Helic√≥ptero", price: 28000000, depreciationSeason:-0.11, maintenanceWeekly: 12000, iptuRateSeason:0, moodGain:14, repGain:5 }
  ];

  // =========================
  // UTIL
  // =========================
  const $ = (id) => document.getElementById(id);
  function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
  function choice(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function formatBRL(n){ return "R$ " + Math.round(n).toLocaleString("pt-BR"); }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=> t.classList.remove("show"), 1900);
  }

  function leagueInfo(id){ return LEAGUES.find(l => l.id === id) || LEAGUES[0]; }
  function posInfo(id){ return POSITIONS.find(p => p.id === id) || POSITIONS[0]; }

  // =========================
  // STATE
  // =========================
  const STORAGE_KEY = "mcj_save_loja_impostos_v6";

  let state = {
    season: 1,
    week: 1,
    weeksPerSeason: 38,
    midWindowWeek: 19,
    news: [],
    newsMax: 8,
    offers: [],
    history: [],
    player: null,

    // imposto pendente (total = renda + iptu)
    tax: {
      pending: false,
      seasonRef: 0,
      dueIncome: 0,
      dueIPTU: 0,
      dueTotal: 0,
      attempts: 0
    },

    // modal financiamento
    fin: { open:false, itemId:null }
  };

  function addNews(text){
    state.news.unshift({ t: Date.now(), text });
    state.news = state.news.slice(0, state.newsMax);
  }

  // =========================
  // PLAYER / FINANCE DEFAULTS
  // =========================
  function ensurePlayer(p){
    p.bank ||= { name:"Santander", invested:0, totalInterest:0, lastInterest:0 };

    p.finance ||= {
      seasonSalaryEarned: 0,
      seasonBonusesEarned: 0,

      // d√≠vidas (separado, mas soma)
      taxDebt: 0,
      generalDebt: 0,

      // hist√≥rico fiscal
      lastTaxDueTotal: 0,
      totalFines: 0,
      lastDebtInterest: 0,

      // financiamentos
      loans: [] // {id, itemName, principal, rateWeekly, weeksLeft, weeksTotal, weeklyPayment, missed, createdAt}
    };

    p.owned ||= []; // {id,name,type,boughtAt, basePrice, currentValue, maintenanceWeekly, iptuRateSeason, moodGain, repGain, appreciationSeason, depreciationSeason}

    p.happiness ??= randInt(55, 80); // üòÑ
  }

  function totalDebt(p){
    ensurePlayer(p);
    return (p.finance.taxDebt||0) + (p.finance.generalDebt||0);
  }

  // =========================
  // ATRIBUTOS / OVERALL
  // =========================
  function genAttributes(baseType, age){
    const ageBoost = (age - 15) * 2;
    const baseMin = baseType === "Base" ? 45 : 55;
    const baseMax = baseType === "Base" ? 75 : 86;

    const PAC = clamp(randInt(baseMin, baseMax) + randInt(0, ageBoost), 35, 95);
    const SHO = clamp(randInt(baseMin, baseMax) + randInt(0, ageBoost), 35, 95);
    const PAS = clamp(randInt(baseMin, baseMax) + randInt(0, ageBoost), 35, 95);
    const DEF = clamp(randInt(baseMin, baseMax) + randInt(0, ageBoost), 35, 95);
    const PHY = clamp(randInt(baseMin, baseMax) + randInt(0, ageBoost), 35, 95);
    return { PAC, SHO, PAS, DEF, PHY };
  }

  function calcOverallFromAttrs(positionId, attrs){
    const w = posInfo(positionId).weights;
    const o = attrs.PAC*w.PAC + attrs.SHO*w.SHO + attrs.PAS*w.PAS + attrs.DEF*w.DEF + attrs.PHY*w.PHY;
    return clamp(Math.round(o), 35, 99);
  }

  function genPotential(ovr){ return clamp(ovr + randInt(6, 18), 60, 95); }
  function decideStartTypeByAge(age){
    const baseChance = age === 15 ? 0.85 : age === 16 ? 0.70 : age === 17 ? 0.45 : 0.25;
    return (Math.random() < baseChance) ? "Base" : "Profissional";
  }
  function decideStartLeagueByNat(nat){
    if(nat === "Brasil") return (Math.random() < 0.80) ? "BR" : "EN";
    if(nat === "Inglaterra") return (Math.random() < 0.85) ? "EN" : "BR";
    if(nat === "Argentina") return (Math.random() < 0.85) ? "AR" : "ES";
    if(nat === "Espanha") return (Math.random() < 0.85) ? "ES" : "EN";
    return (Math.random() < 0.50) ? "EN" : "BR";
  }
  function genPosition(sel){ return (sel && sel !== "AUTO") ? sel : choice(POSITIONS).id; }
  function genSalary(startType){ return (startType === "Base") ? randInt(5000, 15000) : randInt(40000, 120000); }
  function genContractWeeks(startType){ return (startType === "Base") ? randInt(26, 104) : randInt(52, 156); }
  function calcReleaseClause(weeklySalary, startType){
    const factor = startType === "Base" ? randInt(60, 120) : randInt(80, 180);
    return clamp(Math.round((weeklySalary * factor)/1000)*1000, 200000, 50000000);
  }
  function baseReputation(startType, leagueId){
    const base = startType === "Base" ? randInt(8, 22) : randInt(18, 40);
    const l = leagueInfo(leagueId);
    return clamp(Math.round(base * l.repWeight), 1, 100);
  }
  function calcSigningBonus(weeklySalary, rep){
    const w = randInt(2, 10);
    const mult = 1 + (rep/250);
    return clamp(Math.round((weeklySalary * w * mult)/1000)*1000, 10000, 8000000);
  }

  // =========================
  // IMPOSTOS (renda + IPTU)
  // =========================
  function calcIncomeTax(income){
    const x = Math.max(0, income);
    let rate = 0.08;
    if(x > 500_000) rate = 0.12;
    if(x > 2_000_000) rate = 0.16;
    return Math.round((x * rate) / 100) * 100;
  }

  function calcIPTUFromAssets(p){
    ensurePlayer(p);
    let iptu = 0;
    for(const a of p.owned){
      if(a.iptuRateSeason && a.iptuRateSeason > 0){
        iptu += (a.currentValue * a.iptuRateSeason);
      }
    }
    return Math.round(iptu / 100) * 100;
  }

  function taxCaughtChance(){
    const p = state.player;
    if(!p) return 0.25;
    ensurePlayer(p);

    const income = (p.finance.seasonSalaryEarned||0) + (p.finance.seasonBonusesEarned||0);
    const due = (state.tax.dueTotal||0);

    let chance = 0.18;
    chance += clamp(income / 4_000_000, 0, 0.35);     // renda alta
    chance += clamp(due / 6_000_000, 0, 0.25);        // imposto alto
    chance += clamp((p.reputation||0) / 200, 0, 0.30);// ‚Äúvisibilidade‚Äù
    chance += clamp((state.tax.attempts || 0) * 0.10, 0, 0.35);

    return clamp(chance, 0.12, 0.88);
  }

  function openTaxDecisionModal(){
    const p = state.player;
    ensurePlayer(p);

    const dueIncome = Math.max(0, Math.floor(state.tax.dueIncome || 0));
    const dueIPTU = Math.max(0, Math.floor(state.tax.dueIPTU || 0));
    const due = Math.max(0, Math.floor(state.tax.dueTotal || 0));

    const risk = Math.round(taxCaughtChance()*100);
    $("taxModalRisk").textContent = `üëÄ Risco: ${risk}%`;

    $("taxModalBody").innerHTML = `
      <div class="box">
        <div class="boxTitle">Temporada ${state.tax.seasonRef} ‚Ä¢ Impostos totais: ${formatBRL(due)}</div>
        <div class="boxSub">Inclui imposto de renda + IPTU. Para seguir, voc√™ precisa decidir.</div>
        <div class="boxMid">
          <span>üíº Renda (sal√°rio): <b>${formatBRL(p.finance.seasonSalaryEarned||0)}</b></span>
          <span>üéÅ B√¥nus/Luvas: <b>${formatBRL(p.finance.seasonBonusesEarned||0)}</b></span>
          <span>üè† Patrim√¥nio: <b>${formatBRL(netWorth(p))}</b></span>
        </div>
        <div class="boxMid">
          <span>üßæ Imposto renda: <b>${formatBRL(dueIncome)}</b></span>
          <span>üèõÔ∏è IPTU: <b>${formatBRL(dueIPTU)}</b></span>
          <span>üìå D√≠vida atual: <b>${formatBRL(totalDebt(p))}</b></span>
        </div>
      </div>

      <div class="box" style="margin-top:10px">
        <div class="boxTitle">Op√ß√µes</div>
        <div class="boxSub">
          ‚Ä¢ <b>Pagar</b>: se n√£o tiver dinheiro, o restante vira d√≠vida.<br>
          ‚Ä¢ <b>Sonegar</b>: se der errado, multa de <b>150%</b> do total (vira d√≠vida e acumula).
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btnPrimary" id="btnTaxPay">Pagar impostos</button>
          <button class="btn btnDanger" id="btnTaxEvade">Tentar sonegar</button>
        </div>
      </div>
    `;

    $("taxModalBack").classList.add("show");
    $("btnTaxPay").onclick = payTaxes;
    $("btnTaxEvade").onclick = evadeTaxes;
  }

  function closeTaxDecisionModal(){
    $("taxModalBack").classList.remove("show");
  }

  function createSeasonTaxes(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    const income = (p.finance.seasonSalaryEarned||0) + (p.finance.seasonBonusesEarned||0);
    const dueIncome = calcIncomeTax(income);
    const dueIPTU = calcIPTUFromAssets(p);
    const dueTotal = dueIncome + dueIPTU;

    state.tax = {
      pending: dueTotal > 0,
      seasonRef: state.season,
      dueIncome,
      dueIPTU,
      dueTotal,
      attempts: 0
    };

    p.finance.lastTaxDueTotal = dueTotal;

    if(dueTotal > 0){
      addNews(`üßæ Impostos da Temporada ${state.season}: ${formatBRL(dueTotal)} (renda + IPTU). Decida: pagar ou sonegar.`);
      toast("Impostos gerados!");
      openTaxDecisionModal();
    } else {
      state.tax.pending = false;
    }
  }

  function payTaxes(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);
    if(!state.tax.pending) return;

    const due = Math.max(0, Math.floor(state.tax.dueTotal || 0));
    const pay = Math.min(p.wallet, due);
    p.wallet -= pay;

    const remaining = due - pay;
    if(remaining > 0){
      p.finance.taxDebt += remaining;
      addNews(`üßæ Pagou ${formatBRL(pay)}. Faltou ${formatBRL(remaining)} ‚Üí virou d√≠vida de impostos.`);
      p.happiness = clamp(p.happiness - 2, 0, 100);
      toast("Restante virou d√≠vida!");
    } else {
      addNews(`üßæ Impostos pagos: ${formatBRL(due)}.`);
      p.happiness = clamp(p.happiness + 1, 0, 100);
      toast("Impostos pagos!");
    }

    state.tax.pending = false;
    state.tax.dueIncome = state.tax.dueIPTU = state.tax.dueTotal = 0;
    closeTaxDecisionModal();
    startNextSeason();
  }

  function evadeTaxes(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);
    if(!state.tax.pending) return;

    const due = Math.max(0, Math.floor(state.tax.dueTotal || 0));
    state.tax.attempts = (state.tax.attempts || 0) + 1;

    const caught = Math.random() < taxCaughtChance();

    if(caught){
      const fine = Math.round((due * 1.5) / 100) * 100; // 150%
      const totalOwed = due + fine; // 250% total
      p.finance.taxDebt += totalOwed;
      p.finance.totalFines += fine;

      p.reputation = clamp(p.reputation - randInt(2,5), 1, 100);
      p.happiness = clamp(p.happiness - randInt(3,7), 0, 100);

      addNews(`üö® Caiu na sonega√ß√£o! Impostos ${formatBRL(due)} + multa (150%) ${formatBRL(fine)} = d√≠vida ${formatBRL(totalOwed)}.`);
      toast("Multa aplicada!");
    } else {
      // d√° certo (por enquanto)
      p.happiness = clamp(p.happiness + 2, 0, 100);
      addNews(`üò∂‚Äçüå´Ô∏è Sonega√ß√£o deu certo (por enquanto). Voc√™ evitou ${formatBRL(due)} nesta temporada.`);
      toast("Sonega√ß√£o deu certo!");
    }

    state.tax.pending = false;
    state.tax.dueIncome = state.tax.dueIPTU = state.tax.dueTotal = 0;
    closeTaxDecisionModal();
    startNextSeason();
  }

  // D√≠vidas com juros semanal
  function debtTickWeekly(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    const rate = 0.015; // 1,5%/sem
    const total = totalDebt(p);

    if(total > 0){
      // aplica juros proporcionalmente nas duas d√≠vidas
      const interest = total * rate;
      const add = Math.round(interest / 100) * 100;

      // reparte: 60% vai para taxDebt primeiro (s√≥ pra dar ‚Äúcara‚Äù)
      const toTax = Math.min(add, Math.round(add*0.60/100)*100);
      const toGen = add - toTax;

      p.finance.taxDebt += toTax;
      p.finance.generalDebt += toGen;

      p.finance.lastDebtInterest = add;

      // d√≠vida derruba humor um pouco
      if(Math.random() < 0.45){
        p.happiness = clamp(p.happiness - 1, 0, 100);
      }

      // notifica√ß√£o leve
      if(add > 0 && Math.random() < 0.55){
        addNews(`üìå D√≠vidas: juros +${formatBRL(add)} nesta semana.`);
      }
    } else {
      p.finance.lastDebtInterest = 0;
    }
  }

  function payDebt(amount){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    amount = Math.max(0, Math.floor(amount));
    if(amount <= 0) return toast("Digite um valor v√°lido.");
    if(totalDebt(p) <= 0) return toast("Voc√™ n√£o tem d√≠vidas.");
    if(amount > p.wallet) return toast("Sem dinheiro suficiente.");

    // paga primeiro a d√≠vida de impostos
    let pay = amount;
    const payTax = Math.min(pay, p.finance.taxDebt);
    p.finance.taxDebt -= payTax;
    pay -= payTax;

    const payGen = Math.min(pay, p.finance.generalDebt);
    p.finance.generalDebt -= payGen;

    const paidTotal = payTax + payGen;
    p.wallet -= paidTotal;

    p.happiness = clamp(p.happiness + 1, 0, 100);
    addNews(`‚úÖ Pagou ${formatBRL(paidTotal)} em d√≠vidas. Restante: ${formatBRL(totalDebt(p))}.`);
    toast("D√≠vida paga!");
    render();
  }

  // =========================
  // BANCO
  // =========================
  function bankTickWeekly(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    if(p.bank.invested > 0){
      const interest = p.bank.invested * 0.01;
      p.bank.invested += interest;
      p.bank.totalInterest += interest;
      p.bank.lastInterest = interest;
      if(Math.random() < 0.45) addNews(`üè¶ Santander: rendimento +${formatBRL(interest)} (1%).`);
    } else {
      p.bank.lastInterest = 0;
    }
  }
  function invest(amount){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);
    amount = Math.max(0, Math.floor(amount));
    if(amount <= 0) return toast("Digite um valor v√°lido.");
    if(amount > p.wallet) return toast("Voc√™ n√£o tem esse dinheiro.");
    p.wallet -= amount;
    p.bank.invested += amount;
    addNews(`üè¶ Investiu ${formatBRL(amount)} no Santander.`);
    toast("Investido!");
    render();
  }
  function withdraw(amount){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);
    amount = Math.max(0, Math.floor(amount));
    if(amount <= 0) return toast("Digite um valor v√°lido.");
    if(amount > p.bank.invested) return toast("Voc√™ n√£o tem esse valor investido.");
    p.bank.invested -= amount;
    p.wallet += amount;
    addNews(`üè¶ Resgatou ${formatBRL(amount)} do Santander.`);
    toast("Resgatado!");
    render();
  }

  // =========================
  // LOJA: patrim√¥nio / manuten√ß√£o / valoriza√ß√£o / financiamentos
  // =========================
  function netWorth(p){
    ensurePlayer(p);
    let assets = 0;
    for(const own of p.owned) assets += (own.currentValue || 0);
    return assets;
  }

  function applySeasonValuation(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    for(const a of p.owned){
      const cur = Math.max(0, a.currentValue || a.basePrice || 0);
      const app = a.appreciationSeason || 0;
      const dep = a.depreciationSeason || 0;
      const rate = app !== 0 ? app : dep; // um ou outro
      const newVal = cur * (1 + rate);
      a.currentValue = Math.round(newVal / 100) * 100;
    }
  }

  function weeklyMaintenanceTick(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    let totalMaint = 0;
    for(const a of p.owned){
      totalMaint += (a.maintenanceWeekly || 0);
    }

    totalMaint = Math.round(totalMaint / 10) * 10;

    if(totalMaint <= 0) return;

    if(p.wallet >= totalMaint){
      p.wallet -= totalMaint;
      if(Math.random() < 0.40) addNews(`üß∞ Manuten√ß√£o semanal paga: ${formatBRL(totalMaint)}.`);
    } else {
      // faltou dinheiro: vira d√≠vida geral + penalidade
      const deficit = totalMaint - p.wallet;
      p.wallet = 0;
      p.finance.generalDebt += deficit;
      p.reputation = clamp(p.reputation - 1, 1, 100);
      p.happiness = clamp(p.happiness - 2, 0, 100);
      addNews(`‚ö†Ô∏è Manuten√ß√£o atrasada! Faltou ${formatBRL(deficit)} ‚Üí virou d√≠vida.`);
      toast("Manuten√ß√£o virou d√≠vida!");
    }
  }

  // financiamento: pagamento fixo por semana (amortiza√ß√£o simples)
  function calcWeeklyPayment(principal, rWeekly, weeks){
    if(weeks <= 0) return principal;
    if(rWeekly <= 0) return principal / weeks;
    const r = rWeekly;
    const denom = 1 - Math.pow(1 + r, -weeks);
    return (principal * r) / denom;
  }

  function loansTickWeekly(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    const loans = p.finance.loans || [];
    if(loans.length === 0) return;

    for(const L of loans){
      if(L.weeksLeft <= 0) continue;

      // aplica juros no principal
      const interest = L.principal * L.rateWeekly;
      L.principal += interest;

      const payment = L.weeklyPayment;

      if(p.wallet >= payment){
        p.wallet -= payment;

        // reduz principal pelo valor pago
        L.principal -= payment;
        L.weeksLeft -= 1;

        // small mood reward por estar ‚Äúem dia‚Äù
        if(Math.random() < 0.20) p.happiness = clamp(p.happiness + 1, 0, 100);

        if(L.principal <= 0 || L.weeksLeft <= 0){
          L.weeksLeft = 0;
          L.principal = 0;
          addNews(`‚úÖ Financiamento quitado: ${L.itemName}.`);
          toast("Financiamento quitado!");
        } else if(Math.random() < 0.25){
          addNews(`üìÑ Parcela paga (${L.itemName}): ${formatBRL(payment)} ‚Ä¢ Restam ${L.weeksLeft} sem.`);
        }
      } else {
        // n√£o pagou: vira d√≠vida + penalidade
        L.missed = (L.missed || 0) + 1;

        const penalty = Math.round((payment * 0.05) / 10) * 10; // 5% da parcela
        const owed = payment + penalty;

        p.finance.generalDebt += owed;
        p.reputation = clamp(p.reputation - 1, 1, 100);
        p.happiness = clamp(p.happiness - 2, 0, 100);

        L.weeksLeft -= 1;

        addNews(`‚ö†Ô∏è Parcela atrasada (${L.itemName})! ${formatBRL(payment)} + multa ${formatBRL(penalty)} ‚Üí virou d√≠vida.`);
        toast("Parcela virou d√≠vida!");
      }
    }

    // remove quitados
    p.finance.loans = loans.filter(x => x.weeksLeft > 0 || x.principal > 0);
  }

  function buyCash(itemId){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    const item = SHOP_ITEMS.find(x=>x.id===itemId);
    if(!item) return;

    if(p.owned.some(o=>o.id===itemId)) return toast("Voc√™ j√° tem esse item.");
    if(p.wallet < item.price) return toast("Dinheiro insuficiente.");

    p.wallet -= item.price;

    p.owned.push({
      id:item.id,
      name:item.name,
      type:item.type,
      boughtAt: Date.now(),
      basePrice: item.price,
      currentValue: item.price,
      maintenanceWeekly: item.maintenanceWeekly || 0,
      iptuRateSeason: item.iptuRateSeason || 0,
      moodGain: item.moodGain || 0,
      repGain: item.repGain || 0,
      appreciationSeason: item.appreciationSeason || 0,
      depreciationSeason: item.depreciationSeason || 0
    });

    p.happiness = clamp(p.happiness + (item.moodGain||0), 0, 100);
    p.reputation = clamp(p.reputation + (item.repGain||0), 1, 100);

    addNews(`üõí Compra √† vista: ${item.name} por ${formatBRL(item.price)}.`);
    toast("Comprado!");
    render();
  }

  // Modal financiamento
  function openFinModal(itemId){
    const p = state.player; if(!p) return;
    ensurePlayer(p);

    const item = SHOP_ITEMS.find(x=>x.id===itemId);
    if(!item) return;

    state.fin = { open:true, itemId };
    $("finModalTag").innerHTML = `üì¶ <b>${item.name}</b>`;

    $("finModalBody").innerHTML = `
      <div class="box">
        <div class="boxTitle">${item.name}</div>
        <div class="boxSub">Pre√ßo: ${formatBRL(item.price)} ‚Ä¢ Juros do financiamento: <b>0,9%/sem</b></div>
        <div class="boxMid">
          <span>Seu saldo: <b>${formatBRL(p.wallet)}</b></span>
          <span>D√≠vida atual: <b>${formatBRL(totalDebt(p))}</b></span>
        </div>
      </div>

      <div class="box" style="margin-top:10px">
        <div class="boxTitle">Escolha entrada e prazo</div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>Entrada</label>
            <select id="finDown">
              <option value="0.20">20%</option>
              <option value="0.35">35%</option>
              <option value="0.50">50%</option>
            </select>
          </div>
          <div class="col">
            <label>Prazo</label>
            <select id="finWeeks">
              <option value="26">26 semanas</option>
              <option value="52" selected>52 semanas</option>
              <option value="104">104 semanas</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <button class="btn btnPrimary" id="btnFinConfirm">Confirmar financiamento</button>
          <button class="btn" id="btnFinCancel">Cancelar</button>
        </div>

        <div class="tiny" style="margin-top:10px">
          Se faltar dinheiro na parcela, ela vira d√≠vida com multa de 5% e sua reputa√ß√£o cai.
        </div>
      </div>
    `;

    $("finModalBack").classList.add("show");
    $("btnFinCancel").onclick = closeFinModal;
    $("btnFinConfirm").onclick = confirmFinancing;
  }

  function closeFinModal(){
    $("finModalBack").classList.remove("show");
    state.fin = { open:false, itemId:null };
  }

  function confirmFinancing(){
    const p = state.player; if(!p) return;
    ensurePlayer(p);

    const item = SHOP_ITEMS.find(x=>x.id===state.fin.itemId);
    if(!item) return;

    if(p.owned.some(o=>o.id===item.id)) return toast("Voc√™ j√° tem esse item.");

    const downRate = Number($("finDown").value);
    const weeks = Number($("finWeeks").value);
    const rWeekly = 0.009;

    const down = Math.round((item.price * downRate)/100)*100;
    if(p.wallet < down) return toast("Voc√™ n√£o tem dinheiro pra entrada.");

    const principal = item.price - down;
    const weeklyPay = calcWeeklyPayment(principal, rWeekly, weeks);
    const weeklyPayment = Math.round(weeklyPay / 10) * 10;

    // cobra entrada
    p.wallet -= down;

    // adiciona item
    p.owned.push({
      id:item.id,
      name:item.name,
      type:item.type,
      boughtAt: Date.now(),
      basePrice: item.price,
      currentValue: item.price,
      maintenanceWeekly: item.maintenanceWeekly || 0,
      iptuRateSeason: item.iptuRateSeason || 0,
      moodGain: item.moodGain || 0,
      repGain: item.repGain || 0,
      appreciationSeason: item.appreciationSeason || 0,
      depreciationSeason: item.depreciationSeason || 0
    });

    // cria loan
    p.finance.loans.push({
      id: "loan_" + item.id + "_" + Date.now(),
      itemId: item.id,
      itemName: item.name,
      principal: principal,
      rateWeekly: rWeekly,
      weeksLeft: weeks,
      weeksTotal: weeks,
      weeklyPayment: weeklyPayment,
      missed: 0,
      createdAt: Date.now()
    });

    // impacto ‚Äúimediato‚Äù
    p.happiness = clamp(p.happiness + Math.max(1, Math.round((item.moodGain||0)*0.7)), 0, 100);
    p.reputation = clamp(p.reputation + Math.max(0, Math.round((item.repGain||0)*0.7)), 1, 100);

    addNews(`üìÑ Financiou ${item.name}. Entrada ${formatBRL(down)} ‚Ä¢ Parcela ~${formatBRL(weeklyPayment)}/sem por ${weeks} semanas.`);
    toast("Financiamento criado!");
    closeFinModal();
    render();
  }

  function sellItem(ownedIndex){
    const p = state.player; if(!p) return;
    ensurePlayer(p);

    const item = p.owned[ownedIndex];
    if(!item) return;

    // taxa 5%
    const gross = Math.max(0, item.currentValue || 0);
    const fee = Math.round((gross * 0.05) / 10) * 10;
    const net = Math.max(0, gross - fee);

    p.wallet += net;

    // perde parte de humor/reputa√ß√£o se vender algo ‚Äúde status‚Äù
    const moodLoss = Math.max(0, Math.round((item.moodGain||0) * 0.5));
    const repLoss = Math.max(0, Math.round((item.repGain||0) * 0.5));
    p.happiness = clamp(p.happiness - moodLoss, 0, 100);
    p.reputation = clamp(p.reputation - repLoss, 1, 100);

    p.owned.splice(ownedIndex, 1);

    addNews(`üí∏ Vendeu ${item.name} por ${formatBRL(net)} (taxa ${formatBRL(fee)}).`);
    toast("Item vendido!");
    render();
  }

  // =========================
  // GERAR JOGADOR
  // =========================
  function generatePlayer(){
    const name = ($("inpName").value || "Jogador").trim();
    const nat = $("selNat").value;
    const diff = $("selDiff").value;
    const leagueChoice = $("selStartLeague").value;
    const typeChoice = $("selStartType").value;

    const age = randInt(15, 18);
    const startType = (typeChoice === "AUTO") ? decideStartTypeByAge(age) : typeChoice;
    const leagueId = (leagueChoice === "AUTO") ? decideStartLeagueByNat(nat) : leagueChoice;
    const position = genPosition($("selPos").value);

    const weeklySalary = genSalary(startType);
    const attrs = genAttributes(startType, age);
    const overall = calcOverallFromAttrs(position, attrs);
    const potential = genPotential(overall);

    const rep = baseReputation(startType, leagueId);
    const contractWeeks = genContractWeeks(startType);

    state.player = {
      name, nationality:nat, difficulty:diff,
      age, position, type: startType,
      attrs, overall, potential,
      leagueId, leagueName: leagueInfo(leagueId).name,
      club: null,
      weeklySalary,
      contractWeeks,
      releaseClause: calcReleaseClause(weeklySalary, startType),
      morale: randInt(60, 90),
      fitness: randInt(70, 95),
      reputation: rep,
      injuredWeeks: 0,
      wallet: 0,

      bank: { name:"Santander", invested:0, totalInterest:0, lastInterest:0 },
      finance: {
        seasonSalaryEarned: 0,
        seasonBonusesEarned: 0,
        taxDebt: 0,
        generalDebt: 0,
        lastTaxDueTotal: 0,
        totalFines: 0,
        lastDebtInterest: 0,
        loans: []
      },
      owned: [],
      happiness: randInt(55, 80),

      seasonStats: { matches:0, goals:0, assists:0, cleanSheets:0, avgRating:6.6 },
      careerStats: { matches:0, goals:0, assists:0, cleanSheets:0 }
    };

    state.season = 1;
    state.week = 1;
    state.news = [];
    state.offers = [];
    state.history = [];
    state.tax = { pending:false, seasonRef:0, dueIncome:0, dueIPTU:0, dueTotal:0, attempts:0 };

    addNews(`üé≤ Jogador gerado: ${name} (${nat}), ${age} anos, ${position} ‚Ä¢ Overall ${overall}.`);
    toast("Jogador gerado!");
    render();
  }

  // =========================
  // CLUBE INICIAL
  // =========================
  let clubPick = { options:[], selectedIndex: null };

  function buildClubPickOptions(){
    const p = state.player;
    if(!p) return;

    const l = leagueInfo(p.leagueId);
    const picks = new Set();
    while(picks.size < 3) picks.add(choice(l.teams));

    clubPick.options = [...picks].map((clubName)=>{
      const strength = randInt(50, 95);
      const salaryMul = 0.85 + (strength/200);
      const repMul = 0.85 + (strength/220);
      const salary = Math.round(p.weeklySalary * salaryMul / 1000) * 1000;

      return {
        club: clubName,
        leagueId: p.leagueId,
        leagueName: l.name,
        strength,
        weeklySalary: clamp(salary, 5000, 350000),
        repBoost: clamp(Math.round((p.reputation * repMul) - p.reputation), 0, 18)
      };
    });

    clubPick.selectedIndex = null;
  }

  function showClubPick(){
    buildClubPickOptions();
    const p = state.player;
    const l = leagueInfo(p.leagueId);

    $("pickHint").innerHTML = `Voc√™ vai come√ßar na liga <b>${l.name}</b>. Escolha 1 clube:`;

    const box = $("clubPickList");
    box.innerHTML = "";
    clubPick.options.forEach((o, idx)=>{
      const el = document.createElement("div");
      el.className = "box";
      el.style.cursor = "pointer";
      el.innerHTML = `
        <div class="boxTitle">üèüÔ∏è ${o.club}</div>
        <div class="boxSub">${o.leagueName} ‚Ä¢ For√ßa ${o.strength}</div>
        <div class="boxMid">
          <span>üí∞ <b>${formatBRL(o.weeklySalary)}/sem</b></span>
          <span>üèÖ <b>+${o.repBoost}</b> reputa√ß√£o</span>
        </div>
        <div class="tiny">Clique para selecionar</div>
      `;
      el.addEventListener("click", ()=>{
        clubPick.selectedIndex = idx;
        [...box.children].forEach(c => c.style.outline = "none");
        el.style.outline = "2px solid rgba(31,242,154,.45)";
        $("btnConfirmPick").disabled = false;
      });
      box.appendChild(el);
    });

    $("btnConfirmPick").disabled = true;
    showScreen("screenClubPick");
  }

  function confirmClubPick(){
    const p = state.player;
    if(!p) return;
    const idx = clubPick.selectedIndex;
    if(idx === null) return toast("Selecione um clube.");

    const o = clubPick.options[idx];
    p.club = o.club;
    p.weeklySalary = o.weeklySalary;
    p.reputation = clamp(p.reputation + o.repBoost, 1, 100);
    p.releaseClause = calcReleaseClause(p.weeklySalary, p.type);

    addNews(`‚úÖ Clube escolhido: ${p.club} (${o.leagueName}). Sal√°rio: ${formatBRL(p.weeklySalary)}/sem.`);
    toast("Carreira iniciada!");
    showScreen("screenGame");
    render();
  }

  // =========================
  // SIMULA√á√ÉO
  // =========================
  function payWeeklySalary(){
    const p = state.player;
    ensurePlayer(p);
    p.wallet += p.weeklySalary;
    p.finance.seasonSalaryEarned += p.weeklySalary;
    p.contractWeeks = Math.max(0, p.contractWeeks - 1);
  }

  function injuryCheck(){
    const p = state.player;
    if(p.injuredWeeks > 0) return;

    const d = DIFF[p.difficulty] || DIFF.MEDIO;
    const base = 0.012 * d.injuryMul;
    const fitnessRisk = clamp((60 - p.fitness) / 120, 0, 0.20);
    const chance = clamp(base + fitnessRisk, 0.004, 0.12);

    if(Math.random() < chance){
      const weeks = clamp(randInt(1, 7) + (p.fitness < 55 ? 2 : 0), 1, 10);
      p.injuredWeeks = weeks;
      p.morale = clamp(p.morale - randInt(4, 10), 0, 100);
      p.happiness = clamp(p.happiness - 1, 0, 100);
      addNews(`ü©π Les√£o! Fora por ${weeks} semana(s).`);
      toast("Les√£o!");
    }
  }

  function recoveryTick(){
    const p = state.player;
    if(p.injuredWeeks > 0){
      p.injuredWeeks -= 1;
      p.fitness = clamp(p.fitness + randInt(8, 16), 0, 100);
      if(p.injuredWeeks === 0){
        addNews("‚úÖ Recuperado da les√£o!");
        toast("Recuperado!");
      }
    }
  }

  function canPlay(){ return state.player.injuredWeeks === 0; }

  function playChance(){
    const p = state.player;
    const d = DIFF[p.difficulty] || DIFF.MEDIO;
    const base = clamp((p.fitness + p.morale) / 200, 0.35, 0.92);
    const roleMul = (p.type === "Base") ? 0.88 : 1.0;
    const repMul = clamp(0.85 + (p.reputation/300), 0.85, 1.15);
    return clamp(base * roleMul * repMul * d.playMul, 0.15, 0.97);
  }

  function expectedGoalAssistProbs(){
    const p = state.player;
    const skill = p.overall / 100;
    const shot = p.attrs.SHO / 100;
    const pass = p.attrs.PAS / 100;
    const pace = p.attrs.PAC / 100;

    let goalP = (0.05 + skill*0.10) * (0.65 + shot*0.55) * (0.85 + pace*0.25);
    let assistP = (0.04 + skill*0.09) * (0.65 + pass*0.55) * (0.85 + pace*0.20);

    if(p.position === "ATA") { goalP *= 1.35; assistP *= 0.75; }
    if(["PE","PD"].includes(p.position)) { goalP *= 1.05; assistP *= 1.10; }
    if(p.position === "MEI") { goalP *= 0.78; assistP *= 1.38; }
    if(p.position === "VOL") { goalP *= 0.55; assistP *= 0.85; }
    if(p.position === "ZAG") { goalP *= 0.22; assistP *= 0.30; }
    if(p.position === "LAT") { goalP *= 0.38; assistP *= 0.90; }
    if(p.position === "GOL"){ goalP = 0.003; assistP = 0.008; }

    goalP *= clamp(0.85 + (p.fitness/250) + (p.morale/350), 0.70, 1.25);
    assistP *= clamp(0.85 + (p.fitness/260) + (p.morale/360), 0.70, 1.25);

    return { goalP: clamp(goalP, 0, 0.55), assistP: clamp(assistP, 0, 0.45) };
  }

  function growthFromPerformance(rating){
    const p = state.player;
    const d = DIFF[p.difficulty] || DIFF.MEDIO;
    if(p.overall >= p.potential) return;

    let chance = 0.10;
    if(rating >= 8.4) chance += 0.22;
    else if(rating >= 7.6) chance += 0.14;
    else if(rating >= 7.0) chance += 0.06;

    chance *= clamp(0.75 + (p.morale/220) + (p.fitness/260), 0.60, 1.55);
    chance *= d.growthMul;
    if(p.type === "Base") chance *= 1.10;

    chance = clamp(chance, 0.02, 0.65);

    if(Math.random() < chance){
      const pos = posInfo(p.position);
      const dom = Object.entries(pos.weights).sort((a,b)=>b[1]-a[1])[0][0];
      p.attrs[dom] = clamp(p.attrs[dom] + 1, 35, 99);
      const newOvr = calcOverallFromAttrs(p.position, p.attrs);
      if(newOvr > p.overall){
        p.overall = newOvr;
        addNews(`üìà Evolu√ß√£o: overall agora ${p.overall}.`);
      }
    }
  }

  function matchSimulation(){
    const p = state.player;

    if(!canPlay()){
      addNews("üö´ Lesionado: n√£o jogou esta semana.");
      return;
    }

    const played = Math.random() < playChance();
    if(!played){
      p.fitness = clamp(p.fitness + randInt(2, 6), 0, 100);
      p.morale = clamp(p.morale - randInt(0, 2), 0, 100);
      if(Math.random() < 0.35) p.happiness = clamp(p.happiness - 1, 0, 100);
      addNews(`Voc√™ ficou no banco no ${p.club}.`);
      return;
    }

    p.seasonStats.matches += 1;
    p.careerStats.matches += 1;

    const { goalP, assistP } = expectedGoalAssistProbs();
    const g = (Math.random() < goalP) ? 1 : 0;
    const a = (Math.random() < assistP) ? 1 : 0;

    if(p.position !== "GOL"){
      p.seasonStats.goals += g;
      p.seasonStats.assists += a;
      p.careerStats.goals += g;
      p.careerStats.assists += a;
    }

    const skill = p.overall / 100;
    let rating = 6.15 + skill * 2.25
      + (g ? 0.85 : 0)
      + (a ? 0.55 : 0)
      + (Math.random()*0.6 - 0.3);

    rating = clamp(rating, 5.4, 9.7);
    p.seasonStats.avgRating = (p.seasonStats.avgRating * 0.88) + (rating * 0.12);

    p.fitness = clamp(p.fitness - randInt(6, 14), 0, 100);
    p.morale = clamp(p.morale + (rating >= 7.2 ? randInt(2,5) : rating <= 6.2 ? -randInt(1,4) : randInt(0,2)), 0, 100);

    // felicidade
    if(rating >= 8.0) p.happiness = clamp(p.happiness + 1, 0, 100);
    if(rating <= 6.1) p.happiness = clamp(p.happiness - 1, 0, 100);

    growthFromPerformance(rating);

    const parts = [];
    if(g) parts.push("‚öΩ Gol!");
    if(a) parts.push("üÖ∞Ô∏è Assist√™ncia!");
    if(parts.length === 0) parts.push("Jogo ok.");

    addNews(`${parts.join(" ")} Nota: ${rating.toFixed(1)} ‚Ä¢ ${p.club}.`);
  }

  function midSeasonWindowIfNeeded(){
    if(state.week !== state.midWindowWeek) return;
    addNews("ü™ü Janela aberta! Chegaram novas propostas.");
    generateOffers("MID");
    toast("Janela aberta!");
  }

  function playWeek(){
    const p = state.player;
    if(!p || !p.club){ toast("Crie um jogador e escolha o clube."); return; }

    // sal√°rio
    payWeeklySalary();

    // manuten√ß√£o (itens)
    weeklyMaintenanceTick();

    // parcelas (financiamentos)
    loansTickWeekly();

    // banco e d√≠vidas
    bankTickWeekly();
    debtTickWeekly();

    // sa√∫de e jogo
    recoveryTick();
    injuryCheck();
    matchSimulation();

    // janela
    midSeasonWindowIfNeeded();

    state.week += 1;
    if(state.week > state.weeksPerSeason){
      endSeason();
      return;
    }

    render();
  }

  function train(){
    const p = state.player;
    if(!p || !p.club) return;

    if(p.injuredWeeks > 0){
      addNews("üè• Treino virou fisioterapia.");
      p.fitness = clamp(p.fitness + randInt(6, 14), 0, 100);
      p.morale = clamp(p.morale + randInt(0, 2), 0, 100);
      render();
      return;
    }

    const d = DIFF[p.difficulty] || DIFF.MEDIO;
    p.fitness = clamp(p.fitness - randInt(4, 10), 0, 100);

    let gainChance = clamp(0.22 + (p.morale/320) + (p.fitness/460), 0.18, 0.65);
    gainChance *= d.growthMul;
    if(p.type === "Base") gainChance *= 1.08;

    if(p.overall < p.potential && Math.random() < gainChance){
      const pos = posInfo(p.position);
      const dom = Object.entries(pos.weights).sort((a,b)=>b[1]-a[1]).slice(0,2).map(x=>x[0]);
      dom.forEach(k => p.attrs[k] = clamp(p.attrs[k] + randInt(0,1), 35, 99));
      const newOvr = calcOverallFromAttrs(p.position, p.attrs);
      if(newOvr > p.overall){
        p.overall = newOvr;
        addNews(`üèãÔ∏è Treino forte! Overall: ${p.overall}.`);
        p.happiness = clamp(p.happiness + 1, 0, 100);
      } else addNews("üèãÔ∏è Treino bom.");
    } else addNews("üèãÔ∏è Treino feito.");

    p.morale = clamp(p.morale + randInt(0, 3), 0, 100);
    render();
  }

  function rest(){
    const p = state.player;
    if(!p || !p.club) return;

    if(p.injuredWeeks > 0){
      addNews("üõå Descanso + tratamento (recupera√ß√£o melhor).");
      p.fitness = clamp(p.fitness + randInt(12, 24), 0, 100);
      p.morale = clamp(p.morale + randInt(1, 4), 0, 100);
      p.happiness = clamp(p.happiness + 1, 0, 100);
      render();
      return;
    }

    p.fitness = clamp(p.fitness + randInt(10, 22), 0, 100);
    p.morale = clamp(p.morale + randInt(1, 4), 0, 100);
    p.happiness = clamp(p.happiness + 1, 0, 100);
    addNews("üõå Descanso: f√≠sico e moral subiram.");
    render();
  }

  // =========================
  // PROPOSTAS
  // =========================
  function genProject(){
    return choice(["Titularidade r√°pida","Projeto jovem","Time competitivo","Reconstru√ß√£o","Chance de ser estrela","Foco em t√≠tulos"]);
  }
  function pickOfferLeague(){
    const p = state.player;
    return (Math.random() < 0.70) ? p.leagueId : (p.leagueId === "BR" ? "EN" : "BR");
  }
  function genOfferClub(exclude){
    const leagueId = pickOfferLeague();
    const league = leagueInfo(leagueId);
    let club = choice(league.teams);
    let tries = 0;
    while(exclude.has(club + "|" + leagueId) && tries < 18){
      club = choice(league.teams); tries++;
    }
    return { leagueId, leagueName: league.name, club };
  }
  function genOfferSalary(){
    const p = state.player;
    const league = leagueInfo(p.leagueId);
    const base = 32000 + (p.overall * 1400) + (p.reputation * 650);
    const leagueJitter = (league.id === "EN") ? randInt(0, 30000) : randInt(-5000, 15000);
    const jitter = randInt(-15000, 28000) + leagueJitter;
    return clamp(Math.round((base + jitter)/1000)*1000, 12000, 350000);
  }
  function genOfferContractWeeks(){
    const p = state.player;
    const base = randInt(52, 208);
    const bonus = (p.reputation >= 70 ? 26 : 0);
    return clamp(base + bonus, 26, 260);
  }

  function generateOffers(windowType){
    const p = state.player;
    if(!p) return;

    const label = (windowType === "MID") ? "Janela (Meio)" : "Fim de temporada";
    const offersCount = (windowType === "MID") ? randInt(2, 4) : randInt(3, 5);

    const used = new Set([p.club + "|" + p.leagueId]);
    if(windowType !== "MID") state.offers = [];
    else state.offers.forEach(o => used.add(o.club + "|" + o.leagueId));

    for(let i=0;i<offersCount;i++){
      const pick = genOfferClub(used);
      const key = pick.club + "|" + pick.leagueId;
      if(used.has(key)){ i--; continue; }
      used.add(key);

      const weeklySalary = genOfferSalary();
      const contractWeeks = genOfferContractWeeks();
      const signingBonus = calcSigningBonus(weeklySalary, p.reputation);
      const releaseClause = calcReleaseClause(weeklySalary, "Profissional");

      state.offers.push({
        leagueId: pick.leagueId,
        leagueName: pick.leagueName,
        club: pick.club,
        weeklySalary,
        contractWeeks,
        signingBonus,
        releaseClause,
        project: genProject(),
        windowLabel: label
      });
    }
    addNews(`üì® Recebeu ${offersCount} proposta(s) ‚Äî ${label}.`);
  }

  function acceptOffer(idx){
    const p = state.player;
    const o = state.offers[idx];
    if(!p || !o) return;
    ensurePlayer(p);

    p.wallet += o.signingBonus;
    p.finance.seasonBonusesEarned += o.signingBonus;

    p.club = o.club;
    p.leagueId = o.leagueId;
    p.leagueName = o.leagueName;
    p.weeklySalary = o.weeklySalary;
    p.contractWeeks = o.contractWeeks;
    p.releaseClause = o.releaseClause;

    p.happiness = clamp(p.happiness + 2, 0, 100);
    addNews(`‚úÖ Assinou com ${o.club}! Sal√°rio ${formatBRL(o.weeklySalary)}/sem ‚Ä¢ Luvas ${formatBRL(o.signingBonus)}.`);
    state.offers = [];
    toast("Transfer√™ncia feita!");
    render();
  }

  function renewContract(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    const urgency = (p.contractWeeks <= 10) ? 1.15 : (p.contractWeeks <= 26 ? 1.08 : 1.02);
    const perf = 1 + (p.reputation/180) + (p.overall/250);
    const raise = clamp(0.04 + (perf*0.06), 0.05, 0.22) * urgency;

    const newSalary = clamp(Math.round((p.weeklySalary * (1 + raise))/1000)*1000, 5000, 450000);
    const newWeeks = clamp(randInt(52, 182) + (p.reputation >= 70 ? 26 : 0), 26, 260);
    const signingBonus = calcSigningBonus(newSalary, p.reputation);
    const newClause = calcReleaseClause(newSalary, "Profissional");

    state.offers.unshift({
      leagueId: p.leagueId,
      leagueName: p.leagueName,
      club: p.club + " (Renova√ß√£o)",
      weeklySalary: newSalary,
      contractWeeks: newWeeks,
      signingBonus,
      releaseClause: newClause,
      project: "Renova√ß√£o de contrato",
      windowLabel: "Negocia√ß√£o"
    });

    addNews(`üîÅ Renova√ß√£o criada: ${formatBRL(newSalary)}/sem ‚Ä¢ ${newWeeks} semanas ‚Ä¢ Luvas ${formatBRL(signingBonus)}.`);
    toast("Renova√ß√£o criada!");
    render();
  }

  // =========================
  // FIM DE TEMPORADA
  // =========================
  function pushHistory(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    state.history.unshift({
      season: state.season,
      club: p.club,
      league: p.leagueName,
      age: p.age,
      position: p.position,
      overall: p.overall,
      rep: p.reputation,
      happy: p.happiness,
      stats: { ...p.seasonStats },
      taxDue: p.finance.lastTaxDueTotal || 0,
      debtEnd: totalDebt(p),
      netWorth: netWorth(p),
      loans: (p.finance.loans||[]).length
    });

    state.history = state.history.slice(0, 20);
  }

  function endSeason(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    // aplica valoriza√ß√£o/desvaloriza√ß√£o
    applySeasonValuation();

    // guarda hist√≥rico
    pushHistory();

    addNews(`üèÅ Temporada ${state.season} terminou!`);
    generateOffers("END");

    // gera impostos (renda + IPTU) e abre decis√£o
    createSeasonTaxes();

    render();
  }

  function resetSeasonFinanceForNewSeason(){
    const p = state.player;
    ensurePlayer(p);
    p.finance.seasonSalaryEarned = 0;
    p.finance.seasonBonusesEarned = 0;
  }

  function startNextSeason(){
    const p = state.player;
    if(!p) return;
    ensurePlayer(p);

    if(state.tax.pending) return; // s√≥ come√ßa depois de decidir

    state.season += 1;
    state.week = 1;

    // envelhece
    p.age = clamp(p.age + 1, 15, 40);

    // reset stats de temporada
    p.seasonStats = { matches:0, goals:0, assists:0, cleanSheets:0, avgRating:6.6 };

    // reset renda temporada
    resetSeasonFinanceForNewSeason();

    // recupera√ß√£o
    p.fitness = clamp(p.fitness + randInt(10, 22), 0, 100);
    p.morale = clamp(p.morale + randInt(2, 7), 0, 100);
    p.injuredWeeks = 0;

    // felicidade ‚Äúrespira‚Äù
    p.happiness = clamp(p.happiness + 1, 0, 100);

    addNews(`üé¨ Temporada ${state.season} come√ßou!`);
    toast("Nova temporada!");
    render();
  }

  // =========================
  // UI
  // =========================
  function showScreen(which){
    $("screenStart").classList.remove("active");
    $("screenClubPick").classList.remove("active");
    $("screenGame").classList.remove("active");
    $(which).classList.add("active");
  }

  function setActiveTab(tabId){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", t.getAttribute("data-tab") === tabId);
    });
    document.querySelectorAll(".panel").forEach(p=>{
      p.classList.toggle("active", p.id === tabId);
    });
  }

  function renderPlayerPanel(){
    const p = state.player;
    if(!p){ $("playerPanel").innerHTML = `<div class="hint">Nenhum jogador ainda.</div>`; return; }
    ensurePlayer(p);

    const pos = posInfo(p.position);
    const debt = totalDebt(p);

    const inj = p.injuredWeeks > 0
      ? `<span class="tag" style="border-color: rgba(255,93,93,.35)">ü©π <b>${p.injuredWeeks} sem</b></span>`
      : `<span class="tag">‚úÖ Sem les√£o</span>`;

    const debtStyle = debt > 0 ? `style="border-color: rgba(255,93,93,.35)"` : "";

    $("playerPanel").innerHTML = `
      <div class="pill">
        <div>
          <div class="title">${p.name}</div>
          <div class="desc">${p.nationality} ‚Ä¢ ${p.age} anos ‚Ä¢ ${p.type} ‚Ä¢ ${p.position} (${pos.label})</div>
        </div>
        <div class="big">${p.overall}</div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <span class="tag">üèüÔ∏è <b>${p.club || "Sem clube"}</b></span>
        <span class="tag">üèÖ REP: <b>${p.reputation}</b></span>
        <span class="tag">üòÑ Felicidade: <b>${p.happiness}</b></span>
        ${inj}
      </div>

      <div class="row">
        <div class="col"><div class="tag">üí∞ Carteira: <b>${formatBRL(p.wallet)}</b></div></div>
        <div class="col"><div class="tag">üíµ Sal√°rio/sem: <b>${formatBRL(p.weeklySalary)}</b></div></div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col"><div class="tag" ${debtStyle}>üìå D√≠vidas: <b>${formatBRL(debt)}</b></div></div>
        <div class="col"><div class="tag">üè† Patrim√¥nio: <b>${formatBRL(netWorth(p))}</b></div></div>
      </div>

      <div class="tiny" style="margin-top:10px">
        Juros: investimento <b>+1%/sem</b> ‚Ä¢ d√≠vidas <b>+1,5%/sem</b>. Manuten√ß√£o e parcelas s√£o cobradas ao jogar semana.
      </div>
    `;
  }

  function renderSeason(){
    $("seasonLine").textContent = `Temporada ${state.season} ‚Ä¢ Semana ${state.week}/${state.weeksPerSeason}`;
    $("weekBig").textContent = state.week;

    const mid = state.midWindowWeek;
    $("midTag").textContent = (state.week < mid) ? `ü™ü Janela: falta ${mid - state.week} sem`
      : (state.week === mid ? `ü™ü Janela aberta` : `ü™ü Janela passou`);

    const p = state.player;
    const taxBox = $("taxBox");

    if(!p){
      $("taxTag").textContent = "üßæ OK";
      $("taxLine").textContent = "No fim da temporada voc√™ decide pagar ou sonegar.";
      taxBox.innerHTML = `<div class="hint">Crie um jogador.</div>`;
      return;
    }

    ensurePlayer(p);

    if(state.tax.pending){
      $("taxTag").textContent = "üö® PENDENTE";
      $("taxLine").textContent = `Impostos pendentes da Temporada ${state.tax.seasonRef}. Voc√™ precisa decidir.`;
      taxBox.innerHTML = `
        <div class="boxTitle">Impostos pendentes: ${formatBRL(state.tax.dueTotal||0)}</div>
        <div class="boxSub">Clique em ‚ÄúFinalizar Temporada‚Äù para abrir a decis√£o.</div>
        <div class="boxMid">
          <span>üëÄ Risco (se sonegar): <b>${Math.round(taxCaughtChance()*100)}%</b></span>
          <span>üìå D√≠vidas: <b>${formatBRL(totalDebt(p))}</b></span>
        </div>
      `;
    } else {
      $("taxTag").textContent = "üßæ OK";
      $("taxLine").textContent = "No fim da temporada voc√™ decide pagar ou sonegar.";
      taxBox.innerHTML = `
        <div class="boxTitle">‚úÖ Situa√ß√£o fiscal</div>
        <div class="boxSub">√öltimo imposto total: ${formatBRL(p.finance.lastTaxDueTotal||0)} ‚Ä¢ Multas: ${formatBRL(p.finance.totalFines||0)}</div>
        <div class="boxMid">
          <span>üíº Sal√°rio na temporada: <b>${formatBRL(p.finance.seasonSalaryEarned||0)}</b></span>
          <span>üéÅ B√¥nus/luvas: <b>${formatBRL(p.finance.seasonBonusesEarned||0)}</b></span>
          <span>üè† IPTU estimado: <b>${formatBRL(calcIPTUFromAssets(p))}</b></span>
        </div>
      `;
    }
  }

  function renderNews(){
    $("newsTag").textContent = `üì∞ ${state.news.length}`;
    const nl = $("newsList");
    nl.innerHTML = "";
    if(state.news.length === 0){
      nl.innerHTML = `<div class="hint">Sem notifica√ß√µes.</div>`;
      return;
    }
    for(const n of state.news){
      const d = new Date(n.t);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const item = document.createElement("div");
      item.className = "box";
      item.innerHTML = `<div class="boxTitle">${n.text}</div><div class="boxSub">${hh}:${mm}</div>`;
      nl.appendChild(item);
    }
  }

  function renderOffers(){
    const ol = $("offersList");
    ol.innerHTML = "";
    if(state.offers.length === 0){
      ol.innerHTML = `<div class="hint">Nenhuma proposta no momento.</div>`;
      return;
    }
    state.offers.forEach((o, idx)=>{
      const item = document.createElement("div");
      item.className = "box";
      item.innerHTML = `
        <div class="boxTitle">${o.club}</div>
        <div class="boxSub">${o.leagueName} ‚Ä¢ ${o.windowLabel}</div>
        <div class="boxMid">
          <span>üí∞ <b>${formatBRL(o.weeklySalary)}</b>/sem</span>
          <span>üßæ <b>${o.contractWeeks}</b> sem</span>
          <span>ü§ù Luvas <b>${formatBRL(o.signingBonus)}</b></span>
          <span>üí• Multa <b>${formatBRL(o.releaseClause)}</b></span>
          <span>‚≠ê <b>${o.project}</b></span>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btnSmall btnPrimary" data-accept="${idx}">Aceitar</button>
        </div>
      `;
      ol.appendChild(item);
    });

    ol.querySelectorAll("[data-accept]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const idx = Number(e.currentTarget.getAttribute("data-accept"));
        acceptOffer(idx);
      });
    });
  }

  function renderFinancas(){
    const p = state.player;
    const box = $("bankMeters");
    box.innerHTML = "";

    if(!p){
      box.innerHTML = `<div class="hint">Crie um jogador.</div>`;
      return;
    }
    ensurePlayer(p);

    const meters = [
      { k:"Carteira", v: formatBRL(p.wallet) },
      { k:"Investido", v: formatBRL(p.bank.invested) },
      { k:"Rendimento total", v: formatBRL(p.bank.totalInterest) },
      { k:"√öltimo rendimento", v: formatBRL(p.bank.lastInterest) },
      { k:"D√≠vida impostos", v: formatBRL(p.finance.taxDebt || 0) },
      { k:"D√≠vida geral", v: formatBRL(p.finance.generalDebt || 0) },
      { k:"Juros (√∫ltimo)", v: formatBRL(p.finance.lastDebtInterest || 0) },
      { k:"Multas acumuladas", v: formatBRL(p.finance.totalFines || 0) },
      { k:"Banco", v: p.bank.name }
    ];

    meters.forEach(m=>{
      const el = document.createElement("div");
      el.className = "meter";
      el.innerHTML = `<div><div class="k">${m.k}</div><div class="v">${m.v}</div></div><span class="tag">üí≥</span>`;
      box.appendChild(el);
    });

    // loans
    const loans = p.finance.loans || [];
    $("loanTag").textContent = `üìÑ ${loans.length}`;
    const ll = $("loanList");
    ll.innerHTML = "";
    if(loans.length === 0){
      ll.innerHTML = `<div class="hint">Nenhum financiamento ativo.</div>`;
    } else {
      loans.forEach((L)=>{
        const item = document.createElement("div");
        item.className = "box";
        item.innerHTML = `
          <div class="boxTitle">üìÑ ${L.itemName}</div>
          <div class="boxSub">Restam ${L.weeksLeft}/${L.weeksTotal} semanas ‚Ä¢ Juros ${(L.rateWeekly*100).toFixed(1)}%/sem</div>
          <div class="boxMid">
            <span>Parcela: <b>${formatBRL(L.weeklyPayment)}</b></span>
            <span>Saldo (principal): <b>${formatBRL(L.principal)}</b></span>
            <span>Atrasos: <b>${L.missed||0}</b></span>
          </div>
        `;
        ll.appendChild(item);
      });
    }
  }

  function renderShop(){
    const p = state.player;
    const shop = $("shopList");
    const ownedList = $("ownedList");

    shop.innerHTML = "";
    ownedList.innerHTML = "";

    if(!p){
      $("netWorthTag").innerHTML = `üè† Patrim√¥nio: <b>R$ 0</b>`;
      $("ownedTag").textContent = `üì¶ 0`;
      shop.innerHTML = `<div class="hint">Crie um jogador.</div>`;
      ownedList.innerHTML = `<div class="hint">Sem itens.</div>`;
      return;
    }
    ensurePlayer(p);

    $("netWorthTag").innerHTML = `üè† Patrim√¥nio: <b>${formatBRL(netWorth(p))}</b>`;
    $("ownedTag").textContent = `üì¶ ${p.owned.length}`;

    // cat√°logo
    SHOP_ITEMS.forEach(item=>{
      const owned = p.owned.some(o=>o.id===item.id);

      const el = document.createElement("div");
      el.className = "box";

      const varText = item.appreciationSeason ? `üìà +${Math.round(item.appreciationSeason*100)}%/temp`
                   : item.depreciationSeason ? `üìâ ${Math.round(item.depreciationSeason*100)}%/temp`
                   : "‚Äî";

      const iptuText = item.iptuRateSeason ? `üèõÔ∏è IPTU ${(item.iptuRateSeason*100).toFixed(1)}%/temp` : "üèõÔ∏è IPTU: ‚Äî";
      const maintText = item.maintenanceWeekly ? `üß∞ Manut: ${formatBRL(item.maintenanceWeekly)}/sem` : `üß∞ Manut: ‚Äî`;

      el.innerHTML = `
        <div class="boxTitle">${owned ? "‚úÖ" : "üõí"} ${item.name}</div>
        <div class="boxSub">${item.type} ‚Ä¢ Pre√ßo ${formatBRL(item.price)}</div>
        <div class="boxMid">
          <span>${varText}</span>
          <span>${maintText}</span>
          <span>${iptuText}</span>
          <span>üòÑ +${item.moodGain||0}</span>
          <span>üèÖ +${item.repGain||0}</span>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btnSmall btnPrimary" ${owned?"disabled":""} data-buycash="${item.id}">
            ${owned ? "J√° possui" : "Comprar √† vista"}
          </button>
          <button class="btn btnSmall" ${owned?"disabled":""} data-buyfin="${item.id}">
            ${owned ? "‚Äî" : "Financiar"}
          </button>
        </div>
      `;
      shop.appendChild(el);
    });

    shop.querySelectorAll("[data-buycash]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const id = e.currentTarget.getAttribute("data-buycash");
        buyCash(id);
      });
    });
    shop.querySelectorAll("[data-buyfin]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{
        const id = e.currentTarget.getAttribute("data-buyfin");
        openFinModal(id);
      });
    });

    // seus itens
    if(p.owned.length === 0){
      ownedList.innerHTML = `<div class="hint">Voc√™ ainda n√£o comprou nada.</div>`;
    } else {
      p.owned.slice().reverse().forEach((o, revIdx)=>{
        // revIdx √© invertido, precisamos mapear pro √≠ndice real
        const idx = p.owned.length - 1 - revIdx;

        const el = document.createElement("div");
        el.className = "box";

        const d = new Date(o.boughtAt);
        const dt = `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;

        const iptuText = (o.iptuRateSeason && o.iptuRateSeason>0) ? `üèõÔ∏è IPTU ${(o.iptuRateSeason*100).toFixed(1)}%/temp` : "üèõÔ∏è IPTU: ‚Äî";
        const maintText = o.maintenanceWeekly ? `üß∞ ${formatBRL(o.maintenanceWeekly)}/sem` : "üß∞ ‚Äî";

        el.innerHTML = `
          <div class="boxTitle">üè∑Ô∏è ${o.name}</div>
          <div class="boxSub">${o.type} ‚Ä¢ comprado em ${dt}</div>
          <div class="boxMid">
            <span>Valor atual: <b>${formatBRL(o.currentValue||0)}</b></span>
            <span>${maintText}</span>
            <span>${iptuText}</span>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn btnSmall btnDanger" data-sell="${idx}">Vender</button>
          </div>
        `;
        ownedList.appendChild(el);
      });

      ownedList.querySelectorAll("[data-sell]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const idx = Number(e.currentTarget.getAttribute("data-sell"));
          sellItem(idx);
        });
      });
    }
  }

  function renderHistory(){
    $("histTag").textContent = `üìö ${state.history.length} temporadas`;
    const list = $("historyList");
    list.innerHTML = "";

    if(state.history.length === 0){
      list.innerHTML = `<div class="hint">Sem hist√≥rico ainda.</div>`;
      return;
    }

    state.history.forEach(h=>{
      const el = document.createElement("div");
      el.className = "box";
      el.innerHTML = `
        <div class="boxTitle">üèÅ Temporada ${h.season} ‚Ä¢ ${h.club} (${h.league})</div>
        <div class="boxSub">${h.position} ‚Ä¢ Idade ${h.age} ‚Ä¢ OVR ${h.overall} ‚Ä¢ REP ${h.rep} ‚Ä¢ üòÑ ${h.happy}</div>
        <div class="boxMid">
          <span>Jogos <b>${h.stats.matches}</b></span>
          <span>Gols <b>${h.stats.goals}</b></span>
          <span>Assists <b>${h.stats.assists}</b></span>
          <span>Nota <b>${h.stats.avgRating.toFixed(2)}</b></span>
        </div>
        <div class="boxMid">
          <span>Impostos: <b>${formatBRL(h.taxDue||0)}</b></span>
          <span>D√≠vidas: <b>${formatBRL(h.debtEnd||0)}</b></span>
          <span>Patrim√¥nio: <b>${formatBRL(h.netWorth||0)}</b></span>
          <span>Financiamentos: <b>${h.loans||0}</b></span>
        </div>
      `;
      list.appendChild(el);
    });
  }

  function render(){
    renderPlayerPanel();
    renderSeason();
    renderNews();
    renderOffers();
    renderFinancas();
    renderShop();
    renderHistory();

    const hasCareer = !!(state.player && state.player.club);

    $("btnPlayWeek").disabled = !hasCareer;
    $("btnTrain").disabled = !hasCareer;
    $("btnRest").disabled = !hasCareer;
    $("btnEndSeason").disabled = !hasCareer;
    $("btnRenew").disabled = !hasCareer;
  }

  // =========================
  // SAVE/LOAD
  // =========================
  function save(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      toast("Jogo salvo!");
    }catch(e){
      alert("N√£o consegui salvar (storage bloqueado/cheio).");
    }
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ toast("N√£o existe save ainda."); return; }
      state = JSON.parse(raw);

      // defaults
      state.newsMax ??= 8;
      state.offers ??= [];
      state.history ??= [];
      state.tax ??= { pending:false, seasonRef:0, dueIncome:0, dueIPTU:0, dueTotal:0, attempts:0 };
      state.fin ??= { open:false, itemId:null };
      state.weeksPerSeason ??= 38;
      state.midWindowWeek ??= 19;

      if(state.player){
        ensurePlayer(state.player);
        state.player.attrs ||= genAttributes(state.player.type || "Base", state.player.age || 16);
        state.player.overall ||= calcOverallFromAttrs(state.player.position || "ATA", state.player.attrs);
        state.player.potential ||= genPotential(state.player.overall);
        state.player.seasonStats ||= { matches:0, goals:0, assists:0, cleanSheets:0, avgRating:6.6 };
        state.player.careerStats ||= { matches:0, goals:0, assists:0, cleanSheets:0 };
      }

      toast("Save carregado!");
      if(state.player && state.player.club) showScreen("screenGame");
      else if(state.player && !state.player.club) showScreen("screenClubPick");
      else showScreen("screenStart");

      render();

      // se imposto pendente, abre modal
      if(state.tax && state.tax.pending){
        openTaxDecisionModal();
      }
    }catch(e){
      alert("Erro ao carregar o save.");
    }
  }

  function exitGame(){
    showScreen("screenStart");
    toast("Voltando para a tela inicial.");
  }

  // =========================
  // EVENTS
  // =========================
  $("btnGenerate").addEventListener("click", generatePlayer);

  $("btnStartCareer").addEventListener("click", ()=>{
    if(!state.player) generatePlayer();
    showClubPick();
  });

  $("btnBackToStart").addEventListener("click", ()=> showScreen("screenStart"));
  $("btnConfirmPick").addEventListener("click", confirmClubPick);

  $("btnPlayWeek").addEventListener("click", playWeek);
  $("btnTrain").addEventListener("click", train);
  $("btnRest").addEventListener("click", rest);

  $("btnEndSeason").addEventListener("click", ()=>{
    if(state.tax && state.tax.pending){
      openTaxDecisionModal();
      return;
    }
    endSeason();
  });

  $("btnRenew").addEventListener("click", renewContract);

  $("btnClearOffers").addEventListener("click", ()=>{
    state.offers = [];
    renderOffers();
    toast("Propostas limpas.");
  });

  $("btnInvest").addEventListener("click", ()=>{
    const v = Number($("inpInvest").value || 0);
    invest(v);
    $("inpInvest").value = "";
  });

  $("btnWithdraw").addEventListener("click", ()=>{
    const v = Number($("inpWithdraw").value || 0);
    withdraw(v);
    $("inpWithdraw").value = "";
  });

  $("btnPayDebt").addEventListener("click", ()=>{
    const v = Number($("inpPayDebt").value || 0);
    payDebt(v);
    $("inpPayDebt").value = "";
  });

  $("btnSave").addEventListener("click", save);
  $("btnLoad").addEventListener("click", load);
  $("btnExit").addEventListener("click", exitGame);

  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      setActiveTab(btn.getAttribute("data-tab"));
    });
  });

  // travar fechar modal de imposto clicando fora
  $("taxModalBack").addEventListener("click", (e)=>{
    if(e.target === $("taxModalBack")){
      toast("Decida: pagar ou sonegar para seguir.");
    }
  });
  // financiamento pode fechar fora
  $("finModalBack").addEventListener("click", (e)=>{
    if(e.target === $("finModalBack")){
      closeFinModal();
    }
  });

  // Auto-save
  setInterval(()=> { if(state.player) save(); }, 60_000);

  // init
  render();

})();
</script>

</body>
</html>
